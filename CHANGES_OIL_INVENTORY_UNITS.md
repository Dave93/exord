# Изменения в системе учёта масел - Ввод возврата в килограммах

## Обзор изменений

Изменена логика ввода возврата масла. Теперь возврат всегда вводится в килограммах (кг), а система автоматически конвертирует в литры (л) для внутренних расчётов и аналитики.

## Основные изменения

### 1. База данных
- **Новая миграция**: `m241201_000000_add_units_to_oil_inventory.php`
- **Новое поле**:
  - `return_amount_kg` - возврат в килограммах (decimal 10,3)
- **Логика**: Поле `return_amount` остаётся для внутренних расчётов и автоматически заполняется при сохранении

### 2. Модель OilInventory
- **Новая константа**:
  - `KG_TO_LITERS_RATIO = 1.1` - коэффициент конвертации кг в литры

- **Новые методы**:
  - `convertKgToLiters($kg)` - конвертация кг в литры
  - `convertLitersToKg($liters)` - конвертация литров в кг
  - `getReturnInLiters()` - получение возврата в литрах (автоматическая конвертация)

- **Обновлённые методы**:
  - `calculateEvaporation()` - использует возврат в литрах
  - `calculateClosingBalance()` - использует возврат в литрах
  - `updateCalculatedFields()` - автоматически конвертирует кг в литры

- **Обновлённые атрибуты**:
  - Все поля теперь имеют единицы измерения в названиях (л/кг)

### 3. Форма ввода данных
- **Изменения**:
  - Удалён выбор единицы измерения
  - Поле возврата теперь всегда в килограммах
  - Добавлена информация о коэффициенте конвертации
  - Поле `return_amount` скрыто (автоматически заполняется)

### 4. Представления
- **Индексная страница**:
  - Заголовки колонок теперь содержат единицы измерения
  - Колонка "Возврат" показывает значение в кг и конвертированное в л

- **Страница просмотра**:
  - Поле возврата показывает значение в кг и конвертированное в л

- **Дашборд**:
  - Все заголовки метрик обновлены с указанием единиц измерения (л)
  - Таблицы аналитики содержат единицы измерения в заголовках

### 5. Модель поиска
- Добавлена поддержка поиска по новому полю:
  - `return_amount_kg`

## Логика работы

### Ввод и конвертация
- Пользователь всегда вводит возврат в килограммах в поле `return_amount_kg`
- При сохранении система автоматически конвертирует в литры: `return_amount = return_amount_kg * 1.1`
- Все расчёты (испарение, остаток) используют конвертированное значение в литрах

### Отображение данных
- В списках и отчётах показывается значение в кг и конвертированное в л
- Все аналитические расчёты ведутся в литрах
- Дашборд показывает метрики в литрах

## Коэффициент конвертации

Используется коэффициент **1 кг = 1.1 л** для конвертации масла из килограммов в литры. Этот коэффициент можно изменить в константе `KG_TO_LITERS_RATIO` в модели `OilInventory`.

## Обратная совместимость

- Все существующие записи автоматически конвертируются: `return_amount_kg = return_amount / 1.1`
- Старые отчёты продолжают работать
- Новое поле имеет значение по умолчанию 0

## Миграция

Для применения изменений выполните миграцию:

```bash
php yii migrate
```

## Файлы, затронутые изменениями

1. `migrations/m241201_000000_add_units_to_oil_inventory.php` - новая миграция
2. `models/OilInventory.php` - основная модель
3. `models/OilInventorySearch.php` - модель поиска
4. `views/oil-inventory/_form.php` - форма ввода
5. `views/oil-inventory/index.php` - список записей
6. `views/oil-inventory/view.php` - просмотр записи
7. `views/oil-inventory-dashboard/index.php` - дашборд аналитики 