# Изменения в Oil Inventory Dashboard

## Описание изменений

Внесены изменения в систему аналитики учета масла (`oil-inventory-dashboard`) для расширения функциональности для начальников, добавления фильтров и исправления логики учета возврата.

## Основные изменения

### 1. Убраны ограничения по storeId для начальников

- **Проблема**: Раньше все пользователи были ограничены данными только своего магазина
- **Решение**: Администраторы и менеджеры теперь могут просматривать данные по всем магазинам
- **Файл**: `controllers/OilInventoryDashboardController.php`
- **Логика**: 
  ```php
  $isManager = $currentUser && ($currentUser->getIsAdmin() || $currentUser->getIsManager());
  if (!$isManager) {
      // Ограничиваем обычных пользователей их storeId
      $storeFilter = $currentUserStoreId;
  }
  ```

### 2. Добавлены фильтры по дате и магазину

#### Фильтры в контроллере:
- `store_id` - фильтр по магазину (только для менеджеров)
- `date_from` - дата начала периода (по умолчанию - начало текущего месяца)
- `date_to` - дата окончания периода (по умолчанию - сегодня)

#### Модификация всех аналитических методов:
- `getTotalRecords()`
- `getStatusStats()`
- `getMonthlyStats()`
- `getAverageConsumption()`
- `getWeeklyTrend()`
- `getTopConsumptionDays()`
- `getRecentRecords()`
- `getWastageAnalysis()`
- `getEfficiencyMetrics()`

### 3. Обновлен интерфейс

#### Добавлена панель фильтров:
- Поля выбора дат (date picker)
- Выпадающий список магазинов (только для менеджеров)
- Кнопки "Применить" и "Сбросить"

#### Улучшена информативность:
- Индикатор активных фильтров
- Динамический заголовок графика тренда
- Улучшенные сообщения при отсутствии данных

## Технические детали

### Изменения в контроллере
```php
// Новый метод для получения списка магазинов
private function getStoresList()

// Обновлены все аналитические методы для поддержки фильтров
private function getTotalRecords($storeFilter = null, $dateFrom = null, $dateTo = null)
// ... и другие методы
```

### Изменения в представлении
- Добавлен импорт `ArrayHelper` и `ActiveForm`
- Добавлена панель фильтров с использованием Bootstrap
- Обновлены переменные представления
- Улучшена обработка состояний фильтров

## Роли пользователей

### Администраторы и менеджеры:
- Могут просматривать данные по всем магазинам
- Имеют доступ к фильтру по магазинам
- Могут фильтровать по дате

### Обычные пользователи:
- Ограничены данными своего магазина
- Могут фильтровать только по дате
- Не видят фильтр по магазинам

## Совместимость

Изменения полностью обратно совместимы:
- Старые URL без параметров работают как раньше
- Обычные пользователи получают те же данные, что и раньше
- Добавлена только новая функциональность для менеджеров

### 4. Исправлена логика учета возврата

#### Проблема:
В аналитическом дашборде возврат (`return_amount`) неправильно добавлялся к доходу, хотя в модели `OilInventory` он правильно вычитается из остатка.

#### Исправления:
- **Метод `getWeeklyTrend()`**: Возврат теперь включен в общий расход вместо дохода
- **Метод `getEfficiencyMetrics()`**: 
  - Возврат включен во все расчеты общего расхода
  - Добавлена новая метрика "Доля возврата" (`return_percentage`)
  - Исправлен расчет эффективности прихода
- **Метод `getAverageConsumption()`**: Добавлен средний возврат в расчеты
- **Метод `getTopConsumptionDays()`**: Возврат включен в общий расход
- **Метод `getMonthlyStats()`**: Исправлен расчет общего расхода

#### Обновления интерфейса:
- Добавлен столбец "Возврат" в таблицу топ дней по расходу
- Добавлена метрика "Доля возврата" в раздел эффективности
- Обновлен график среднего расхода для включения возврата
- Добавлены дополнительные виджеты метрик, включая средний возврат

#### Логическая корректность:
Теперь во всех расчетах возврат правильно учитывается как расход (минус от остатка), что соответствует бизнес-логике в модели `OilInventory`.

### 5. Добавлены новые представления для управления записями

#### Представление заполненных записей:
- **Файл**: `views/oil-inventory/filled.php`
- **URL**: `/oil-inventory/filled`
- **Функционал**: 
  - Отображение записей со статусом "Заполнен"
  - Быстрые действия: просмотр, принять, отклонить
  - Информационное уведомление о назначении страницы
  - Фильтрация записей по статусу

#### Представление детального рассмотрения:
- **Файл**: `views/oil-inventory/review.php`
- **URL**: `/oil-inventory/review/{id}`
- **Функционал**:
  - Детальная информация о записи
  - Расчет остатка с разбивкой по операциям
  - Кнопки для принятия/отклонения записи
  - Предупреждения о необратимости действий

#### Новые действия контроллера:
- `actionFilled()` - список заполненных записей
- `actionReview($id)` - детальный просмотр для рассмотрения
- `actionApprove($id)` - принятие записи (статус → "принят")
- `actionReject($id)` - отклонение записи (статус → "отклонён")

#### Обновления навигации:
- Добавлена кнопка "Заполненные записи" на главной странице списка
- Хлебные крошки для навигации между представлениями
- Кнопки возврата к списку записей

## Файлы изменений

1. `controllers/OilInventoryDashboardController.php` - основная логика дашборда
2. `views/oil-inventory-dashboard/index.php` - интерфейс аналитики
3. `controllers/OilInventoryController.php` - добавлены новые действия для управления записями
4. `views/oil-inventory/filled.php` - новое представление заполненных записей
5. `views/oil-inventory/review.php` - новое представление детального рассмотрения
6. `views/oil-inventory/index.php` - обновлена навигация
7. `CHANGES_OIL_INVENTORY_DASHBOARD.md` - документация изменений 