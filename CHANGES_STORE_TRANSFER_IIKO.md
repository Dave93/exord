# Интеграция внутреннего перемещения с iiko

**Дата:** 03.11.2024
**Версия:** 1.0

## Обзор изменений

Добавлена автоматическая интеграция функционала внутреннего перемещения (StoreTransfer) с системой iiko. Теперь при финальном утверждении заявки на перемещение автоматически создаются документы внутреннего перемещения в iiko через REST API v2.

## Измененные файлы

### 1. models/Iiko.php

**Добавлен метод:** `createInternalTransferDoc(StoreTransfer $model)`

**Функционал:**
- Проверяет, что заявка имеет статус `COMPLETED`
- Получает все утвержденные позиции (`STATUS_APPROVED`) с количеством > 0
- Группирует позиции по филиалу-источнику (`source_store_id`)
- Создает отдельный документ для каждой пары магазинов (источник → получатель)
- Отправляет POST запросы на `/resto/api/v2/documents/internalTransfer`
- Возвращает детальный результат выполнения для каждого документа

**Формат запроса к iiko API:**
```json
{
  "dateIncoming": "2024-11-03T15:30",
  "status": "NEW",
  "comment": "Внутреннее перемещение #123",
  "storeFromId": "UUID-магазина-источника",
  "storeToId": "UUID-магазина-получателя",
  "items": [
    {
      "productId": "UUID-продукта",
      "amount": 5.5
    }
  ]
}
```

**Возвращаемое значение:**
```php
[
    'success' => true/false,
    'message' => 'Текстовое описание результата',
    'details' => [
        ['success' => true, 'message' => 'Создан документ перемещения из Склад'],
        ['success' => true, 'message' => 'Создан документ перемещения из Цех']
    ]
]
```

### 2. controllers/StoreTransferController.php

**Изменен метод:** `actionFinalApprove($id)`

**Добавленная логика:**
- После успешного commit транзакции проверяется:
  - Заявка завершена (`STATUS_COMPLETED`)
  - Есть утвержденные позиции
- Если условия выполнены, вызывается `Iiko::createInternalTransferDoc()`
- Результат отображается в flash-сообщениях:
  - **Успех:** "Заявка успешно утверждена. Все документы внутреннего перемещения успешно созданы в iiko"
  - **Ошибка:** Предупреждение с деталями, заявка остается утвержденной

**Строки кода:** 337-361 в StoreTransferController.php

## Workflow процесса

```
Офис утверждает заявку
         |
         v
Позиции получают статус APPROVED
         |
         v
Заявка получает статус COMPLETED
         |
         v
Автоматически создаются документы в iiko
         |
         v
Для каждой пары (источник → получатель):
  - Формируется JSON с позициями
  - POST запрос на API iiko
  - Создается документ со статусом NEW
         |
         v
Результат отображается пользователю
```

## Особенности реализации

### Множественные источники
Если в одной заявке продукты запрашиваются из разных филиалов-источников, система создает **несколько документов** внутреннего перемещения — по одному для каждой пары магазинов.

**Пример:**
Заявка #123 от "Ресторан А":
- 5 кг муки из "Склад"
- 3 л молока из "Цех"
- 2 кг сахара из "Склад"

Будет создано **2 документа**:
1. Склад → Ресторан А (мука + сахар)
2. Цех → Ресторан А (молоко)

### Обработка ошибок
- Если создание документов в iiko **не удалось**, заявка остается утвержденной в EXORD
- Пользователь видит предупреждение с деталями ошибки
- Детали включают информацию по каждому документу отдельно

### Только утвержденные позиции
В iiko передаются только позиции со статусом `APPROVED` и `approved_quantity > 0`.
Отклоненные позиции (`REJECTED`) не попадают в документы.

## Интеграция с iiko REST API v2

### Endpoint
```
POST {baseUrl}/resto/api/v2/documents/internalTransfer?key={token}
```

### Авторизация
Используется метод `Iiko::auth()` для получения токена.

### Headers
```
Content-Type: application/json
```

### Проверка ответа
Успешное создание определяется наличием:
- `response['id']` - ID созданного документа
- `response['success'] === true` - флаг успеха

## Тестирование

### Сценарий 1: Успешное создание
1. Создайте заявку на перемещение с несколькими позициями
2. Укажите разные филиалы-источники
3. Утвердите все позиции через `actionFinalApprove`
4. Проверьте:
   - Заявка имеет статус `COMPLETED`
   - Flash-сообщение содержит информацию о созданных документах
   - В iiko созданы соответствующие документы

### Сценарий 2: Частичное утверждение
1. Создайте заявку с 5 позициями
2. Утвердите 3 позиции, отклоните 2
3. Проверьте:
   - Создается документ только с 3 утвержденными позициями
   - Отклоненные не попадают в iiko

### Сценарий 3: Ошибка iiko API
1. Временно отключите iiko или измените credentials
2. Утвердите заявку
3. Проверьте:
   - Заявка остается утвержденной
   - Отображается предупреждение с ошибкой
   - Можно повторить отправку вручную (будущая функция)

## Известные ограничения

1. **Нет повторной отправки**: Если создание документа в iiko не удалось, нет автоматического механизма повторной отправки
2. **Нет отслеживания ID документов**: ID созданных документов в iiko не сохраняются в базе данных EXORD
3. **Нет синхронизации статусов**: Изменение статуса документа в iiko не отражается в EXORD

## Будущие улучшения

- [ ] Добавить поле `iiko_document_id` в таблицу для хранения ID документов
- [ ] Реализовать кнопку ручной повторной отправки
- [ ] Добавить лог всех отправленных запросов в iiko
- [ ] Синхронизация статусов документов из iiko обратно в EXORD

## Связь с другими модулями

Этот функционал реализован по аналогии с:
- **ProductWriteoff** - списание продуктов ([models/Iiko.php:722-802](models/Iiko.php))
- Использует тот же подход: автоматическое создание документов после утверждения

## Контакты и поддержка

При возникновении проблем с интеграцией:
- Проверьте логи в `runtime/logs/`
- Убедитесь, что credentials iiko актуальны
- Проверьте сетевое соединение с API iiko

---

**Статус:** ✅ Реализовано и готово к production
**Дата последнего обновления:** 03.11.2024
